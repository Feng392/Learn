<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
    <script></script>
</head>

<body>
    <script>
        // 以下为上证指数在某段时间内的数据, 根据需求完成以下题目
        const data = [
            // [日期, 开盘价, 收盘价, 最低价, 最高价]
            ['2013/1/24', 2320.26, 2320.26, 2287.3, 2362.94],
            ['2013/1/25', 2300, 2291.3, 2288.26, 2308.38],
            ['2013/1/28', 2295.35, 2346.5, 2295.35, 2346.92],
            ['2013/1/29', 2347.22, 2358.98, 2337.35, 2363.8],
            ['2013/1/30', 2360.75, 2382.48, 2347.89, 2383.76],
            ['2013/1/31', 2383.43, 2385.42, 2371.23, 2391.82],
            ['2013/2/1', 2377.41, 2419.02, 2369.57, 2421.15],
            ['2013/2/4', 2425.92, 2428.15, 2417.58, 2440.38],
            ['2013/2/5', 2411, 2433.13, 2403.3, 2437.42],
            ['2013/2/6', 2432.68, 2434.48, 2427.7, 2441.73],
            ['2013/2/7', 2430.69, 2418.53, 2394.22, 2433.89],
            ['2013/2/8', 2416.62, 2432.4, 2414.4, 2443.03],
            ['2013/2/18', 2441.91, 2421.56, 2415.43, 2444.8],
            ['2013/2/19', 2420.26, 2382.91, 2373.53, 2427.07],
            ['2013/2/20', 2383.49, 2397.18, 2370.61, 2397.94],
            ['2013/2/21', 2378.82, 2325.95, 2309.17, 2378.82],
            ['2013/2/22', 2322.94, 2314.16, 2308.76, 2330.88],
            ['2013/2/25', 2320.62, 2325.82, 2315.01, 2338.78],
            ['2013/2/26', 2313.74, 2293.34, 2289.89, 2340.71],
            ['2013/2/27', 2297.77, 2313.22, 2292.03, 2324.63],
            ['2013/2/28', 2322.32, 2365.59, 2308.92, 2366.16],
            ['2013/3/1', 2364.54, 2359.51, 2330.86, 2369.65],
            ['2013/3/4', 2332.08, 2273.4, 2259.25, 2333.54],
            ['2013/3/5', 2274.81, 2326.31, 2270.1, 2328.14],
            ['2013/3/6', 2333.61, 2347.18, 2321.6, 2351.44],
            ['2013/3/7', 2340.44, 2324.29, 2304.27, 2352.02],
            ['2013/3/8', 2326.42, 2318.61, 2314.59, 2333.67],
            ['2013/3/11', 2314.68, 2310.59, 2296.58, 2320.96],
            ['2013/3/12', 2309.16, 2286.6, 2264.83, 2333.29],
            ['2013/3/13', 2282.17, 2263.97, 2253.25, 2286.33],
            ['2013/3/14', 2255.77, 2270.28, 2253.31, 2276.22],
            ['2013/3/15', 2269.31, 2278.4, 2250, 2312.08],
            ['2013/3/18', 2267.29, 2240.02, 2239.21, 2276.05],
            ['2013/3/19', 2244.26, 2257.43, 2232.02, 2261.31],
            ['2013/3/20', 2257.74, 2317.37, 2257.42, 2317.86],
            ['2013/3/21', 2318.21, 2324.24, 2311.6, 2330.81],
            ['2013/3/22', 2321.4, 2328.28, 2314.97, 2332],
            ['2013/3/25', 2334.74, 2326.72, 2319.91, 2344.89],
            ['2013/3/26', 2318.58, 2297.67, 2281.12, 2319.99],
            ['2013/3/27', 2299.38, 2301.26, 2289, 2323.48],
            ['2013/3/28', 2273.55, 2236.3, 2232.91, 2273.55],
            ['2013/3/29', 2238.49, 2236.62, 2228.81, 2246.87],
            ['2013/4/1', 2229.46, 2234.4, 2227.31, 2243.95],
            ['2013/4/2', 2234.9, 2227.74, 2220.44, 2253.42],
            ['2013/4/3', 2232.69, 2225.29, 2217.25, 2241.34],
            ['2013/4/8', 2196.24, 2211.59, 2180.67, 2212.59],
            ['2013/4/9', 2215.47, 2225.77, 2215.47, 2234.73],
            ['2013/4/10', 2224.93, 2226.13, 2212.56, 2233.04],
            ['2013/4/11', 2236.98, 2219.55, 2217.26, 2242.48],
            ['2013/4/12', 2218.09, 2206.78, 2204.44, 2226.26],
            ['2013/4/15', 2199.91, 2181.94, 2177.39, 2204.99],
            ['2013/4/16', 2169.63, 2194.85, 2165.78, 2196.43],
            ['2013/4/17', 2195.03, 2193.8, 2178.47, 2197.51],
            ['2013/4/18', 2181.82, 2197.6, 2175.44, 2206.03],
            ['2013/4/19', 2201.12, 2244.64, 2200.58, 2250.11],
            ['2013/4/22', 2236.4, 2242.17, 2232.26, 2245.12],
            ['2013/4/23', 2242.62, 2184.54, 2182.81, 2242.62],
            ['2013/4/24', 2187.35, 2218.32, 2184.11, 2226.12],
            ['2013/4/25', 2213.19, 2199.31, 2191.85, 2224.63],
            ['2013/4/26', 2203.89, 2177.91, 2173.86, 2210.58],
            ['2013/5/2', 2170.78, 2174.12, 2161.14, 2179.65],
            ['2013/5/3', 2179.05, 2205.5, 2179.05, 2222.81],
            ['2013/5/6', 2212.5, 2231.17, 2212.5, 2236.07],
            ['2013/5/7', 2227.86, 2235.57, 2219.44, 2240.26],
            ['2013/5/8', 2242.39, 2246.3, 2235.42, 2255.21],
            ['2013/5/9', 2246.96, 2232.97, 2221.38, 2247.86],
            ['2013/5/10', 2228.82, 2246.83, 2225.81, 2247.67],
            ['2013/5/13', 2247.68, 2241.92, 2231.36, 2250.85],
            ['2013/5/14', 2238.9, 2217.01, 2205.87, 2239.93],
            ['2013/5/15', 2217.09, 2224.8, 2213.58, 2225.19],
            ['2013/5/16', 2221.34, 2251.81, 2210.77, 2252.87],
            ['2013/5/17', 2249.81, 2282.87, 2248.41, 2288.09],
            ['2013/5/20', 2286.33, 2299.99, 2281.9, 2309.39],
            ['2013/5/21', 2297.11, 2305.11, 2290.12, 2305.3],
            ['2013/5/22', 2303.75, 2302.4, 2292.43, 2314.18],
            ['2013/5/23', 2293.81, 2275.67, 2274.1, 2304.95],
            ['2013/5/24', 2281.45, 2288.53, 2270.25, 2292.59],
            ['2013/5/27', 2286.66, 2293.08, 2283.94, 2301.7],
            ['2013/5/28', 2293.4, 2321.32, 2281.47, 2322.1],
            ['2013/5/29', 2323.54, 2324.02, 2321.17, 2334.33],
            ['2013/5/30', 2316.25, 2317.75, 2310.49, 2325.72],
            ['2013/5/31', 2320.74, 2300.59, 2299.37, 2325.53],
            ['2013/6/3', 2300.21, 2299.25, 2294.11, 2313.43],
            ['2013/6/4', 2297.1, 2272.42, 2264.76, 2297.1],
            ['2013/6/5', 2270.71, 2270.93, 2260.87, 2276.86],
            ['2013/6/6', 2264.43, 2242.11, 2240.07, 2266.69],
            ['2013/6/7', 2242.26, 2210.9, 2205.07, 2250.63],
            ['2013/6/13', 2190.1, 2148.35, 2126.22, 2190.1],
        ];
        // [日期, 开盘价, 收盘价, 最低价, 最高价]
        // 1. 找出整段数据中, 最低价是哪一天发生的
        // const min = Math.min(...data.map(d => d[3]));
        // const minItem = data.find(d => d[3] === min);
        // 方法二
        const arr = [...data];
        console.log(arr.sort((a, b) => a[3] - b[3])[0][0]);
        // 2. 以收盘价为基准, 计算整段数据的均价
        // 方法一
        // let sum = 0;
        // for (const d of data) {
        //     sum += d[2];
        // }
        // console.log(sum / data.length);
        // 方法二
        function avg(data) {
            return (data.reduce((prve, current) => {
                prve += current[2];
                return prve;
            }, 0) / data.length);
        }
        console.log(avg(data));
        // 3. 封装一个函数, 输入两个日期, 计算这两个日期之间的最高价和最低价
        // [日期, 开盘价, 收盘价, 最低价, 最高价]
        function getMinMaxPrice(data, start, end) {
            // 排序好的数据
            const sortedData = data
                .map(d => [dayjs(d[0]).valueOf(), ...d.slice(1)])
                .sort((a, b) => a[0] - b[0]);
            // 把开始和结束的事件转换为时间戳
            const startTimestamp = dayjs(start).valueOf();
            const endTimestamp = dayjs(end).valueOf();
            // a到b之间 slice(开始索引, 结束索引) 
            const startIdx = sortedData.findIndex(d => d[0] === startTimestamp);
            const endIdx = sortedData.findIndex(d => d[0] === endTimestamp);
            // '2013/2/1' 到 '2013/2/5'的数据
            const currentData = sortedData.slice(startIdx, endIdx + 1);
            return [
                Math.min(...currentData.map(d => d[3])),
                Math.max(...currentData.map(d => d[4])),
            ];
        }
        console.log( getMinMaxPrice(data, '2013/2/1', '2013/2/5') ); // [2369.57, 2440.38]

        // 4. 封装一个函数, 输入两个日期, 计算这两个日期之间的最高价和最低价发生的日期
        function getMinMaxPriceDate(data, start, end) {
            // 排序好的数据
            const sortedData = data
                .map(d => [dayjs(d[0]).valueOf(), ...d.slice(1)])
                .sort((a, b) => a[0] - b[0]);

            const startTimestamp = dayjs(start).valueOf();
            const endTimestamp = dayjs(end).valueOf();

            // a到b之间 slice(开始索引, 结束索引)
            const startIdx = sortedData.findIndex(d => d[0] === startTimestamp);
            const endIdx = sortedData.findIndex(d => d[0] === endTimestamp);

            // '2013/2/1' 到 '2013/2/5'的数据
            const currentData = sortedData.slice(startIdx, endIdx + 1);

            return [
                dayjs(currentData.sort((a, b) => a[3] - b[3])[0][0]).format('YYYY/MM/DD'),
                dayjs(currentData.sort((a, b) => b[4] - a[4])[0][0]).format('YYYY/MM/DD'),
            ];
        }
        console.log(getMinMaxPriceDate(data, '2013/2/1', '2013/2/5')); // ['2013/2/1', '2013/2/4']

        // 方法二 new Date 方法会返回一个表示当前日期和时间的 Date 对象。这个返 回值可以用来进行比较运算，例如检查一个日期是否在另一个日期之前或之后。
        // function getminMaxPriceDate(data, start, end) {
        //     const startTime = new Date(start);
        //     const endTime = new Date(end);
        //     const betweenItem = data.filter(
        //         (item) => new Date(item[0]) >= startTime && new Date(item[0]) <= endTime)
        //     console.log(betweenitem);
        //     const maxDate = betweenItem.sort((a, b) => b[4] - a[4])[0][0];
        //     const minDate = betweenItem.sort((a, b) => a[3] - b[3])[0][0];
        //     return {
        //         最高价日期: maxDate,
        //         最低价日期: minDate,
        //     }
        // }
        // console.log(getminMaxPriceDate(data, '2013/2/1', '2013/2/5')); // [2369.57, 2440.38]
        
        // 5.tiger 封装一个函数, 输入两个日期, 以收盘价为基准, 返回这两个日期之间的所有拐点出现的时间
        // 拐点: 拐点两边的数据, 一个是上升趋势, 一个是下降趋势
        function getTurnPoints(data, start, end) {
            // 排序好的数据
            const sortedData = data
                .map(d => [dayjs(d[0]).valueOf(), ...d.slice(1)])
                .sort((a, b) => a[0] - b[0]);

            const startTimestamp = dayjs(start).valueOf();
            const endTimestamp = dayjs(end).valueOf();

            // a到b之间 slice(开始索引, 结束索引)
            const startIdx = sortedData.findIndex(d => d[0] === startTimestamp);
            const endIdx = sortedData.findIndex(d => d[0] === endTimestamp);

            // '2013/2/1' 到 '2013/2/5'的数据
            const currentData = sortedData.slice(startIdx, endIdx + 1);
            // 定义一个新数组
            const res = [];
            // 找拐点，去掉首尾
            for (let i = 1; i < currentData.length - 1; i++) {
                // 收盘价
                const close = currentData[i][2];
                // 前一天收盘价
                const prevClose = currentData[i - 1][2];
                // 后一天收盘价
                const nextClose = currentData[i + 1][2];
                if (
                    (close > prevClose && close > nextClose)
                    || (close < prevClose && close < nextClose)
                ) {
                    const timestamp = currentData[i][0];
                    res.push(dayjs(timestamp).format('YYYY/MM/DD'));
                }
            }
            return res;
        }
        console.log(getTurnPoints(data, '2013/2/1', '2013/2/5')); // ['2013/2/1', '2013/2/4']
    </script>
</body>

</html>